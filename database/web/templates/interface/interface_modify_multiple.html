{% extends 'layout.html' %}

{% block content %}
<div  style="margin-bottom: 100px;">
    <h3>Interface List:</h3>
    <form method="get" id="filterForm">
        {{ filter.form.as_p }}
        <button type="submit" id="btnf1">Filter</button>
        <button type="reset" id="resetButton" class="btnf2">Reset</button>
    </form>
    {% if formset.total_form_count > 0 %}
    <form method="post">
        {% csrf_token %}
        {{ formset.management_form }}
        <table class="table table-bordered" id="interface-table">
            <thead>
                <thead>
                    <tr>
                        <th style="width: 80px;">Interface Name</th>
                        <th style="width: 70px;">Height [mm]</th>
                        <th style="width: 70px;">Int. Diameter [mm]</th>
                        <th style="width: 70px"> Total Link</th>
                        <th>Total Arm</th>
                        <th>Total Section [mm²]</th>
                        <th>Ext. Diameter [mm]</th>
                        <!-- <th>Theo. height [mm]</th> -->
                        <th>Acc. Mass [g]</th>
                        <th>Fin. O. Diam. [mm]</th>
                        <th>Fin. Acc. section [mm²]</th>
                        <th>Safety Factor [%]</th>
                        <th>Interface's center X [mm]</th>
                        <th>Interface's center Y [mm]</th>
                        <th>Interface's center Z [mm]</th>
                        <th>Direction vector X [mm]</th>
                        <th>Direction vector Y [mm]</th>
                        <th>Direction vector Z [mm]</th>
                        <th>Division Step</th>
                        <th colspan="2">Operation</th>
                    </tr>
                </thead>
            </thead>
            <tbody>
                {% for field in formset %}
                <tr class="interface-form">
                    
                    <tr class="interface-form">
                        <td contenteditable="true">{{ field.interfaceName }}
                            {% if field.height.value or field.intDiameter.value or field.totalLink.value or field.totalArm.value or field.totalSection.value or field.extDiameter.value or field.accMass.value or field.finODiam.value or field.finAccSection.value or field.safetyFactor.value or field.interfaceCenterX.value or field.interfaceCenterY.value or field.interfaceCenterZ.value or field.directionVectorX.value or field.directionVectorY.value or field.directionVectorZ.value or field.divisionStep.value %}
                            {% if not field.interfaceName.value %}
                                <span style="color: red;">{{ interfaceError }}</span>
                            {% endif %}{% endif %}</td>

                        <td contenteditable="true">{{ field.height }}</td>
                        <td contenteditable="true">{{ field.intDiameter }}</td>
                        <td contenteditable="true">{{ field.totalLink }}</td>
                        <td contenteditable="true">{{ field.totalArm }}</td>

                        <td contenteditable="true">{{ field.totalSection }}</td>
                        <td contenteditable="true">{{ field.extDiameter }}</td>
                        <td contenteditable="true">{{ field.accMass }}</td>
                        <td contenteditable="true">{{ field.finODiam }}</td>

                        <td contenteditable="true">{{ field.finAccSection }}</td>
                        <td contenteditable="true">{{ field.safetyFactor }}</td>
                        <td contenteditable="true">{{ field.interfaceCenterX }}</td>
                        <td contenteditable="true">{{ field.interfaceCenterY }}</td>

                        <td contenteditable="true">{{ field.interfaceCenterZ }}</td>
                        <td contenteditable="true">{{ field.directionVectorX }}</td>
                        <td contenteditable="true">{{ field.directionVectorY }}</td>
                        <td contenteditable="true">{{ field.directionVectorZ }}</td>
                        <td contenteditable="true">{{ field.divisionStep }}</td>
                       
                    <td class="text-center">
                        <input type="hidden" name="{{ form.id.name }}" value="{{ form.id.value }}">
                        <button type="button" class="btn btn-danger remove-form">Delete</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <button type="submit" class="btn btn-primary" id="btns">Save</button>
    </form>
    {% else %}
        <h2>This table is empty.</h2>
    {% endif %}
</div>

<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="alert alert-danger alert-dismissible fade in" role="alert">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4>Are you sure you want to delete it?</h4>
            <p style="margin: 20px 0;">After deletion, all related data associated with it will be deleted. Are you sure you want to continue?</p>
            <p>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Confirm</button>
                <button type="button" class="btn btn-default" data-dismiss="modal" id="cancelDeleteBtn">Cancel</button>
            </p>
        </div>
    </div>
</div>
{% endblock %}

{% block css %}
<style>
    table {
        border-collapse: collapse;
        width: 100%;
        margin-bottom: 200px;
    }
    th, td {
        border: 1px solid #ddd;
        padding: 0px;
        text-align: center;
    }
    tr:nth-child(even) {
        background-color: #f2f2f2;
    }
    th {
        background-color: #4CAF50;
        color: white;
    }
    #btnf1, .btnf2 {
        width: 100px;
        background-color: #49b7be;
        color: white;
        padding: 5px 10px;
        margin: 8px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    #btns {
        width: 100px;
        background-color: #13bd13;
        color: white;
        padding: 5px 10px;
        margin: 8px;
        margin-left: 90%;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    #id_project, #id_part, input[type="text"] {
        width: 100%;
        padding: 8px;
        margin: 0px 0;
        display: inline-block;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
    }
</style>
{% endblock %}

{% block js %}
<script>
$(document).ready(function() {
    $('#resetButton').click(function() {
        window.location.href = window.location.pathname;  
    });

    let DELETE_ID = 0;

     
    function deleteAction(id) {
        DELETE_ID = id;
        $('#myModal').modal('show');
    }

     
    function confirmDelete() {
        $.ajax({
            url: "/interface/delete/",
            type: "GET",
            data: { aid: DELETE_ID },
            dataType: "JSON",
            success: function(res) {
                if (res.status) {
                    location.reload();
                } else {
                    alert(res.error);
                }
            }
        });
    }

    
    function cancelDelete() {
        DELETE_ID = 0;
        $('#myModal').modal('hide');
    }

    
    $(document).on('click', '.remove-form', function() {
        let row = $(this).closest('tr');
        let interfaceId = row.find('input[name$="-id"]').val();
        if (interfaceId) {
            deleteAction(interfaceId);
        } else {
            row.remove();
        }
    });

    $('#confirmDeleteBtn').click(function() {
        confirmDelete();
    });

    $('#cancelDeleteBtn').click(function() {
        cancelDelete();
    });


    // Handle paste event to populate table cells
    $('#interface-table tbody').on('paste', 'td', function(e) {
        e.preventDefault();
        var text = (e.originalEvent || e).clipboardData.getData('text/plain');
        var rows = text.split('\n');
        var $currentRow = $(this).closest('tr');
        var startRowIndex = $currentRow.index();
        var startColIndex = $(this).index();

        rows.forEach(function(row, rowIndex) {
            if (row.trim() !== '') {
                var cols = row.split('\t');
                var $row = $('#interface-table tbody tr').eq(startRowIndex + rowIndex);
                if ($row.length === 0) {
                    $('#add-interface').click();
                    $row = $('#interface-table tbody tr').last();
                }
                cols.forEach(function(col, colIndex) {
                    var $cell = $row.find('td').eq(startColIndex + colIndex);
                    $cell.find('input').val(col.trim() || '');
                });
            }
        });
    });
});
</script>
{% endblock %}
